<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tanda Tangan Digital â€” Canvas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      :root {
        --accent: #6c63ff;
      }
      body {
        background: linear-gradient(180deg, #f8f9ff, #ffffff);
        min-height: 100vh;
      }
      .card {
        border-radius: 14px;
        box-shadow: 0 8px 30px rgba(18, 18, 50, 0.06);
      }
      .canvas-wrap {
        border: 1px dashed rgba(0, 0, 0, 0.06);
        border-radius: 8px;
        padding: 10px;
        background: #fff;
      }
      canvas {
        touch-action: none;
        width: 100%;
        height: 240px;
        border-radius: 6px;
      }
      .small-muted {
        font-size: 0.85rem;
        color: #6b6b6b;
      }
      .btn-accent {
        background: var(--accent);
        color: #fff;
      }
    </style>
  </head>

  <body>
    <div class="container py-4">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card p-3">
            <h4 class="mb-1">Tanda Tangan Digital</h4>
            <p class="small-muted mb-2">
              Buat tanda tangan menggunakan jari (HP) atau mouse.
            </p>

            <div class="mt-2 canvas-wrap">
              <canvas id="sigCanvas"></canvas>
            </div>

            <div class="d-flex gap-2 mt-3 flex-wrap">
              <button id="clearBtn" class="btn btn-secondary">Bersihkan</button>
              <button id="undoBtn" class="btn btn-outline-secondary">Undo</button>

              <div class="ms-auto">
                <label class="small-muted me-2">Ketebalan</label>
                <input id="thickness" type="range" min="1" max="6" value="3" />
              </div>
            </div>

            <hr />

            <form id="metaForm" class="row g-2">
              <div class="col-12">
                <label class="form-label">Nama</label>
                <input
                  id="nameInput"
                  class="form-control"
                  placeholder="Nama lengkap"
                  required
                />
              </div>
              <div class="col-12 d-flex gap-2">
                <button id="saveBtn" type="button" class="btn btn-accent shadow">
                  Simpan
                </button>
                <div id="status" class="align-self-center small-muted">&nbsp;</div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // === CONFIG ===
      const API_URL =
        "https://script.google.com/macros/s/AKfycbydmAPQ_XI-E12rWQT5lUHQ-e_KnkRhn5DEddveOxASiXjZaF8erLhR9K8-WFLQwqoz/exec";

      const canvas = document.getElementById("sigCanvas");
      const ctx = canvas.getContext("2d");
      let drawing = false;
      let last = { x: 0, y: 0 };

      // Paths: setiap path = { thickness: number, points: [] }
      let paths = [];

      function resizeCanvas() {
        const ratio = window.devicePixelRatio || 1;
        const w = canvas.clientWidth;
        const h = 240;

        canvas.width = w * ratio;
        canvas.height = h * ratio;

        canvas.style.height = h + "px";

        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(ratio, ratio);

        redraw();
      }

      window.addEventListener("resize", resizeCanvas);

      function getPos(e) {
        if (e.touches && e.touches.length) e = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
      }

      function startDraw(e) {
        drawing = true;
        const p = getPos(e);
        last = p;

        const thickness = Number(document.getElementById("thickness").value);

        paths.push({
          thickness,
          points: [{ x: p.x, y: p.y }],
        });
      }

      function moveDraw(e) {
        if (!drawing) return;
        e.preventDefault();

        const p = getPos(e);
        const curr = paths[paths.length - 1];
        curr.points.push({ x: p.x, y: p.y });

        ctx.lineJoin = ctx.lineCap = "round";
        ctx.lineWidth = curr.thickness;

        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();

        last = p;
      }

      function endDraw() {
        drawing = false;
      }

      function redraw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (const path of paths) {
          ctx.beginPath();
          ctx.lineJoin = ctx.lineCap = "round";
          ctx.lineWidth = path.thickness;
          ctx.strokeStyle = "#111";

          const pts = path.points;
          if (!pts.length) continue;

          ctx.moveTo(pts[0].x, pts[0].y);
          for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y);
          ctx.stroke();
        }
      }

      canvas.addEventListener("mousedown", startDraw);
      canvas.addEventListener("touchstart", startDraw);
      window.addEventListener("mousemove", moveDraw);
      canvas.addEventListener("touchmove", moveDraw, { passive: false });
      window.addEventListener("mouseup", endDraw);
      canvas.addEventListener("touchend", endDraw);

      document.getElementById("clearBtn").addEventListener("click", () => {
        paths = [];
        redraw();
      });

      document.getElementById("undoBtn").addEventListener("click", () => {
        paths.pop();
        redraw();
      });

      document.getElementById("saveBtn").addEventListener("click", async () => {
        const name = document.getElementById("nameInput").value.trim();
        const status = document.getElementById("status");

        if (!name) {
          return Swal.fire("Nama wajib diisi!", "Masukkan nama.", "warning");
        }
        if (!paths.length) {
          return Swal.fire("Tanda tangan kosong!", "Silakan buat dulu.", "info");
        }

        status.textContent = "Mengunggah...";

        const dataURL = canvas.toDataURL("image/png");
        const base64 = dataURL.split(",")[1];

        const filename =
          "ttd_" +
          name.replace(/[^a-z0-9]/gi, "_").toLowerCase() +
          "_" +
          Date.now() +
          ".png";

        const form = new FormData();
        form.append("data", base64);
        form.append("mimetype", "image/png");
        form.append("filename", filename);
        form.append("name", name);

        try {
          await fetch(API_URL, { method: "POST", body: form, mode: "no-cors" });

          Swal.fire(
            "Berhasil!",
            "Tanda tangan disimpan ke Drive & Sheet.",
            "success"
          );

          document.getElementById("nameInput").value = "";
          paths = [];
          redraw();
          status.textContent = "";
        } catch (err) {
          console.error(err);
          Swal.fire("Gagal!", "Terjadi kesalahan upload.", "error");
          status.textContent = "Gagal mengunggah.";
        }
      });

      resizeCanvas();
    </script>
  </body>
</html>
